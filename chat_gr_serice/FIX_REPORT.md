# é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ—¥æœŸ
2025-02-09

---

## ğŸ”´ é—®é¢˜1: Gradio Chatbotæ¶ˆæ¯æ ¼å¼é”™è¯¯

### é”™è¯¯ä¿¡æ¯
```
gradio.exceptions.Error: "Data incompatible with messages format.
Each message should be a dictionary with 'role' and 'content' keys or a ChatMessage object."
```

### æ ¹æœ¬åŸå› 

Gradio 4.0+ ç‰ˆæœ¬çš„Chatbotç»„ä»¶è¦æ±‚æ¶ˆæ¯æ ¼å¼ä¸ºï¼š

```python
# âœ… æ­£ç¡®æ ¼å¼ (Gradio 4.0+)
[
    {"role": "user", "content": "ç”¨æˆ·æ¶ˆæ¯"},
    {"role": "assistant", "content": "åŠ©æ‰‹å›å¤"}
]
```

è€Œä¸æ˜¯æ—§ç‰ˆæœ¬çš„åˆ—è¡¨æ ¼å¼ï¼š

```python
# âŒ é”™è¯¯æ ¼å¼ (æ—§ç‰ˆæœ¬)
[
    ["ç”¨æˆ·æ¶ˆæ¯", "åŠ©æ‰‹å›å¤"],
    [None, "ç¬¬äºŒæ¡åŠ©æ‰‹å›å¤"]
]
```

### ä¿®å¤æ–¹æ¡ˆ

#### ä¿®æ”¹ `format_history()` å‡½æ•°

**ä¿®æ”¹å‰** (app.py:75-85):
```python
def format_history(messages: List) -> List:
    """æ ¼å¼åŒ–æ¶ˆæ¯å†å²"""
    formatted = []
    for msg in messages:
        if msg.role == "user":
            formatted.append([msg.content, None])
        elif formatted and formatted[-1][1] is None:
            formatted[-1][1] = msg.content
        else:
            formatted.append([None, msg.content])
    return formatted
```

**ä¿®æ”¹å** (app.py:75-86):
```python
def format_history(messages: List) -> List[Dict[str, str]]:
    """
    æ ¼å¼åŒ–æ¶ˆæ¯å†å²ä¸ºGradio 4.0+æ ¼å¼
    è¿”å›: [{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}]
    """
    formatted = []
    for msg in messages:
        formatted.append({
            "role": msg.role,
            "content": msg.content
        })
    return formatted
```

#### ä¿®æ”¹åˆå§‹åŒ–æ¶ˆæ¯

**ä¿®æ”¹å‰**:
```python
def create_new_session():
    return [[None, "ğŸ‘‹ æ‚¨å¥½ï¼..."]]  # âŒ æ—§æ ¼å¼
```

**ä¿®æ”¹å**:
```python
def create_new_session():
    return [{"role": "assistant", "content": "ğŸ‘‹ æ‚¨å¥½ï¼..."}]  # âœ… æ–°æ ¼å¼
```

#### ä¿®æ”¹æ¸…ç©ºæ¶ˆæ¯

**ä¿®æ”¹å‰**:
```python
def clear_chat():
    return [[None, "æ–°ä¼šè¯å·²åˆ›å»º..."]]  # âŒ
```

**ä¿®æ”¹å**:
```python
def clear_chat():
    return []  # âœ… è¿”å›ç©ºåˆ—è¡¨
```

### éªŒè¯ç»“æœ

```bash
$ python test_logic.py

âœ… æ ¼å¼åŒ–å‡½æ•°éªŒè¯é€šè¿‡
âœ… è¾¹ç•Œæƒ…å†µæµ‹è¯•é€šè¿‡
âœ… å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡
âœ… æ¶ˆæ¯æ ¼å¼ç¬¦åˆGradio 4.0+æ ‡å‡†
```

---

## ğŸ” é—®é¢˜2: Webäº¤äº’é€»è¾‘æµç¨‹æ£€æŸ¥

### æ£€æŸ¥é¡¹ç›®

#### âœ… 1. ç”¨æˆ·è¾“å…¥å¤„ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥
  â†“
process_user_input(user_message, history)
  â†“
è·å–/åˆ›å»ºä¼šè¯
  â†“
æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ä¼šè¯
  â†“
åˆ¤æ–­ï¼šwaiting_for_input?
  â”œâ”€ YES â†’ restart_workflow()
  â””â”€ NO  â†’ start_workflow()
  â†“
æäº¤å¼‚æ­¥ä»»åŠ¡
  â†“
è¿”å›æ›´æ–°åçš„å¯¹è¯å†å²
```

**æ£€æŸ¥ç»“æœ**: âœ… é€»è¾‘æ­£ç¡®

#### âœ… 2. å¼‚æ­¥å¤„ç†æµç¨‹

```
async_processor.submit_task()
  â†“
åœ¨äº‹ä»¶å¾ªç¯ä¸­è¿è¡Œ _run_task()
  â†“
await asyncio.sleep(2)  # æ¨¡æ‹Ÿå·¥ä½œæµ
  â†“
è·å–å·¥ä½œæµç»“æœ
  â†“
æ‰§è¡Œå›è°ƒ workflow_callback()
  â†“
æ ¹æ®çŠ¶æ€æ·»åŠ æ¶ˆæ¯åˆ°ä¼šè¯
```

**æ£€æŸ¥ç»“æœ**: âœ… é€»è¾‘æ­£ç¡®

#### âœ… 3. å·¥ä½œæµçŠ¶æ€å¤„ç†

```python
if result["status"] == WorkflowStatus.INTERRUPT:
    # è®¾ç½®ç­‰å¾…æ ‡å¿—
    session.waiting_for_input = True
    # æ·»åŠ è¯¢é—®æ¶ˆæ¯
    session.add_message("assistant", result["message"])

elif result["status"] == WorkflowStatus.SUCCESS:
    # æ¸…é™¤ç­‰å¾…æ ‡å¿—
    session.waiting_for_input = False
    # æ·»åŠ ç»“æœæ¶ˆæ¯å’Œå¯è§†åŒ–é“¾æ¥
    session.add_message("assistant", result["message"], result.get("visualization_url"))

elif result["status"] == WorkflowStatus.FAIL:
    # æ¸…é™¤ç­‰å¾…æ ‡å¿—
    session.waiting_for_input = False
    # æ·»åŠ é”™è¯¯æ¶ˆæ¯
    session.add_message("assistant", result["message"])
```

**æ£€æŸ¥ç»“æœ**: âœ… é€»è¾‘æ­£ç¡®

#### âœ… 4. ä¼šè¯ç®¡ç†æµç¨‹

```
åˆ›å»ºä¼šè¯
  â”œâ”€ session_manager.create_session()
  â”œâ”€ ç”Ÿæˆå”¯ä¸€ session_id
  â””â”€ åˆå§‹åŒ–ç©ºæ¶ˆæ¯åˆ—è¡¨

æ·»åŠ æ¶ˆæ¯
  â”œâ”€ session.add_message(role, content, url)
  â”œâ”€ åˆ›å»º Message å¯¹è±¡
  â””â”€ è¿½åŠ åˆ° messages åˆ—è¡¨

è·å–ä¼šè¯
  â”œâ”€ session_manager.get_session(id)
  â””â”€ è¿”å› Session å¯¹è±¡

è·å–æ‰€æœ‰ä¼šè¯
  â”œâ”€ session_manager.get_all_sessions()
  â””â”€ è¿”å›ä¼šè¯åˆ—è¡¨
```

**æ£€æŸ¥ç»“æœ**: âœ… çº¿ç¨‹å®‰å…¨ï¼Œé€»è¾‘æ­£ç¡®

#### âœ… 5. UIåˆ·æ–°æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"
  â†“
refresh_ui()
  â†“
è·å–å½“å‰ä¼šè¯
  â†“
format_history(messages)  # æ ¼å¼åŒ–ä¸ºå­—å…¸æ ¼å¼
  â†“
get_reference_info()  # è·å–å¯è§†åŒ–é“¾æ¥
  â†“
è¿”å›æ›´æ–°åçš„UIæ•°æ®
```

**æ£€æŸ¥ç»“æœ**: âœ… é€»è¾‘æ­£ç¡®

---

## ğŸ“Š æµ‹è¯•åœºæ™¯è¦†ç›–

### åœºæ™¯1: ç®€å•æˆåŠŸå¯¹è¯ âœ…

```
ç”¨æˆ·: "å¸®æˆ‘åˆ†æé”€å”®æ•°æ®"
  â†’ start_workflow()
  â†’ [å¼‚æ­¥å¤„ç†]
  â†’ SUCCESS çŠ¶æ€
  â†’ æ˜¾ç¤ºç»“æœå’Œå¯è§†åŒ–é“¾æ¥
```

### åœºæ™¯2: ä¸­æ–­-é‡å¯æµç¨‹ âœ…

```
ç”¨æˆ·: "åˆ†æç”¨æˆ·è¡Œä¸º"
  â†’ start_workflow()
  â†’ INTERRUPT çŠ¶æ€
  â†’ "éœ€è¦æ›´å¤šä¿¡æ¯ï¼šè¯·æä¾›æ•°æ®èŒƒå›´"
  â†“
ç”¨æˆ·: "æœ€è¿‘ä¸€å‘¨çš„æ•°æ®"
  â†’ restart_workflow()
  â†’ [å¼‚æ­¥å¤„ç†]
  â†’ SUCCESS çŠ¶æ€
  â†’ æ˜¾ç¤ºæœ€ç»ˆç»“æœ
```

### åœºæ™¯3: å¤±è´¥å¤„ç† âœ…

```
ç”¨æˆ·: "æ‰§è¡Œå¤æ‚åˆ†æ"
  â†’ start_workflow()
  â†’ FAIL çŠ¶æ€
  â†’ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
```

### åœºæ™¯4: è¾¹ç•Œæƒ…å†µ âœ…

```
âœ… ç©ºæ¶ˆæ¯åˆ—è¡¨
âœ… åªæœ‰ç”¨æˆ·æ¶ˆæ¯
âœ… åªæœ‰åŠ©æ‰‹æ¶ˆæ¯
âœ… ç‰¹æ®Šå­—ç¬¦å¤„ç†
âœ… å¤šæ¡è¿ç»­æ¶ˆæ¯
```

---

## ğŸ¯ å‘ç°çš„æ½œåœ¨é—®é¢˜

### âš ï¸ é—®é¢˜1: å¼‚æ­¥å›è°ƒä¸ä¼šè‡ªåŠ¨åˆ·æ–°UI

**ç°è±¡**: å·¥ä½œæµå®Œæˆåï¼Œæ¶ˆæ¯å·²æ·»åŠ åˆ°ä¼šè¯ï¼Œä½†UIä¸ä¼šè‡ªåŠ¨åˆ·æ–°

**è§£å†³æ–¹æ¡ˆ**:
- ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç‚¹å‡»"ğŸ”„ åˆ·æ–°çŠ¶æ€"æŒ‰é’®
- æˆ–è€…åœ¨ `process_user_input` ä¸­è‡ªåŠ¨è½®è¯¢çŠ¶æ€

**å½“å‰è®¾è®¡**: ä½¿ç”¨æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®ï¼Œç”¨æˆ·æ§åˆ¶åˆ·æ–°æ—¶æœº

### âš ï¸ é—®é¢˜2: å¤šä¼šè¯ç®¡ç†

**ç°è±¡**: å½“å‰æ€»æ˜¯ä½¿ç”¨æœ€åä¸€ä¸ªä¼šè¯

**è§£å†³æ–¹æ¡ˆ**: å¯ä»¥åœ¨UIä¸­æ·»åŠ ä¼šè¯åˆ‡æ¢åŠŸèƒ½

**å½“å‰è®¾è®¡**: ç®€åŒ–è®¾è®¡ï¼Œä½¿ç”¨å•ä¼šè¯æ¨¡å¼

### âš ï¸ é—®é¢˜3: å¼‚æ­¥ä»»åŠ¡æ— è¶…æ—¶æ§åˆ¶

**ç°è±¡**: å¦‚æœå·¥ä½œæµä¸€ç›´ä¸è¿”å›ï¼Œä»»åŠ¡ä¼šä¸€ç›´ç­‰å¾…

**å»ºè®®**: åœ¨ `async_processor.py` ä¸­æ·»åŠ è¶…æ—¶ï¼š

```python
async def _run_task(self, ...):
    try:
        result = await asyncio.wait_for(
            self._fetch_result(),
            timeout=300.0  # 5åˆ†é’Ÿè¶…æ—¶
        )
    except asyncio.TimeoutError:
        return {"status": "fail", "message": "å·¥ä½œæµè¶…æ—¶"}
```

---

## âœ… éªŒè¯æ¸…å•

- [x] Gradioæ¶ˆæ¯æ ¼å¼æ­£ç¡®
- [x] ç”¨æˆ·è¾“å…¥å¤„ç†æµç¨‹æ­£ç¡®
- [x] å¼‚æ­¥å¤„ç†æµç¨‹æ­£ç¡®
- [x] å·¥ä½œæµçŠ¶æ€å¤„ç†æ­£ç¡®
- [x] ä¼šè¯ç®¡ç†æµç¨‹æ­£ç¡®
- [x] UIåˆ·æ–°æµç¨‹æ­£ç¡®
- [x] ç®€å•å¯¹è¯æµç¨‹æµ‹è¯•é€šè¿‡
- [x] ä¸­æ–­-é‡å¯æµç¨‹æµ‹è¯•é€šè¿‡
- [x] å¤±è´¥å¤„ç†æµç¨‹æµ‹è¯•é€šè¿‡
- [x] è¾¹ç•Œæƒ…å†µæµ‹è¯•é€šè¿‡

---

## ğŸ“ ä»£ç ä¿®æ”¹æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶

1. **app.py** (ä¸»è¦ä¿®æ”¹)
   - ä¿®æ”¹ `format_history()` å‡½æ•°è¿”å›å­—å…¸æ ¼å¼
   - ä¿®æ”¹ `create_new_session()` è¿”å›å­—å…¸æ ¼å¼
   - ä¿®æ”¹ `clear_chat()` è¿”å›ç©ºåˆ—è¡¨
   - æ·»åŠ å‰¯æ ‡é¢˜è¯´æ˜

2. **test_logic.py** (æ–°å¢)
   - å®Œæ•´çš„äº¤äº’æµç¨‹æµ‹è¯•
   - æ ¼å¼åŒ–å‡½æ•°æµ‹è¯•
   - è¾¹ç•Œæƒ…å†µæµ‹è¯•

### ä¿®æ”¹çš„è¡Œæ•°

- **app.py**: ä¿®æ”¹çº¦20è¡Œä»£ç 
- **test_logic.py**: æ–°å¢çº¦300è¡Œæµ‹è¯•ä»£ç 

---

## ğŸš€ ä½¿ç”¨å»ºè®®

### å¯åŠ¨åº”ç”¨

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. æµ‹è¯•é€»è¾‘
python test_logic.py

# 3. å¯åŠ¨åº”ç”¨
python app.py

# 4. è®¿é—®
http://localhost:7860
```

### æµ‹è¯•æµç¨‹

1. **ç®€å•æµ‹è¯•**: è¾“å…¥ "åˆ†æé”€å”®æ•°æ®" â†’ ç­‰å¾…2ç§’ â†’ ç‚¹å‡»åˆ·æ–°
2. **ä¸­æ–­æµ‹è¯•**: è¾“å…¥ "åˆ†æç”¨æˆ·è¡Œä¸º" â†’ æŸ¥çœ‹ä¸­æ–­æ¶ˆæ¯ â†’ è¡¥å……è¾“å…¥ â†’ åˆ·æ–°
3. **å¤±è´¥æµ‹è¯•**: è¾“å…¥ "æ‰§è¡Œå¤æ‚åˆ†æ" â†’ æŸ¥çœ‹é”™è¯¯æ¶ˆæ¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **README_SIMPLIFIED.md** - ç®€åŒ–ç‰ˆä½¿ç”¨è¯´æ˜
- **QUICK_REF.md** - å¿«é€Ÿå‚è€ƒ
- **test_logic.py** - é€»è¾‘æµ‹è¯•è„šæœ¬

---

## ğŸ‰ æ€»ç»“

### ä¿®å¤çš„é—®é¢˜

1. âœ… **Gradioæ¶ˆæ¯æ ¼å¼é”™è¯¯** - å·²ä¿®å¤ï¼Œä½¿ç”¨å­—å…¸æ ¼å¼
2. âœ… **Webäº¤äº’é€»è¾‘æµç¨‹** - å·²æ£€æŸ¥ï¼Œé€»è¾‘æ­£ç¡®
3. âœ… **å®Œæ•´æµ‹è¯•è¦†ç›–** - å·²æ·»åŠ ï¼Œåœºæ™¯å…¨é¢

### ä»£ç è´¨é‡

- âœ… æ ¼å¼æ­£ç¡®
- âœ… é€»è¾‘æ¸…æ™°
- âœ… æµ‹è¯•å®Œæ•´
- âœ… æ–‡æ¡£å®Œå–„

### å¯ä»¥ç›´æ¥ä½¿ç”¨

```bash
python app.py  # å¯åŠ¨åº”ç”¨ï¼Œè®¿é—® http://localhost:7860
```

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²éªŒè¯é€šè¿‡ï¼ğŸŠ
